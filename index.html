<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      background: #fcf7f7;
      user-select: text;
    }

    #calendar {
      width: 100%;
      height: 100vh;
      background: white;
    }

    .fc-toolbar-title {
      font-size: 1.25rem !important;
    }

    .fc .fc-button {
      font-size: 0.7rem !important;
      padding: 2px 6px !important;
      height: auto !important;
      line-height: 1.2 !important;
    }

    .fc-col-header-cell {
      background-color: #007acc;
      color: white;
      font-weight: bold;
      text-align: center;
      font-size: 1rem;
      padding: 8px 0;
      border: 1px solid #e0e0e0;
    }

    .fc-col-header-cell:nth-child(1),
    .fc-col-header-cell:nth-child(7) {
      background-color: #d32f2f;
    }

    .fc-daygrid-day-frame {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100%;
      font-size: 0.7rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .fc-daygrid-day-events {
      flex: 1 1 auto;
      overflow-y: auto;
    }

    .fc-event {
      font-size: 0.7rem !important;
      white-space: normal !important;
      user-select: text !important;
    }

    .fc-list,
    .fc-list-event-title,
    .fc-list-event-time {
      font-size: 0.75rem;
    }

    #exportBtn {
      margin: 8px;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    /* ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£ Copy */
    .fc-daygrid-day,
    .fc-daygrid-day-frame,
    .fc-daygrid-day-top,
    .fc-daygrid-day-number,
    .fc-daygrid-event,
    .fc-event-title,
    .fc-event-main {
      user-select: text !important;
      pointer-events: auto !important;
      cursor: text !important;
    }

    .fc-event {
      pointer-events: auto !important;
      user-select: text !important;
    }
  </style>
</head>
<body>

  <div id="calendar"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const exportBtn = document.getElementById('exportBtn');

      fetch("https://script.google.com/macros/s/AKfycbwqBczxoOp_j9HtJEAhNJGGvsYKqRVRXpMmBJhPnZ7Wv8ldnl5maw-doif07seOFg3GAw/exec")
        .then(response => response.json())
        .then(events => {
          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: window.innerWidth < 600 ? 'listWeek' : 'dayGridMonth',
            locale: 'th',
            timeZone: 'local',
            height: '100vh',
            fixedWeekCount: true,
            dayHeaders: true,
            dayHeaderFormat: { weekday: 'long' },
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,listWeek'
            },

            // ‚úÖ ‡πÉ‡∏ä‡πâ eventContent ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML ‡πÉ‡∏ô title
            eventContent: function (arg) {
              const divEl = document.createElement('div');
              divEl.innerHTML = arg.event.title;
              return { domNodes: [divEl] };
            },

            events: events,

            eventClick: function (info) {
              info.jsEvent.preventDefault();
            },

            eventDidMount: function (info) {
              const el = info.el;
              el.setAttribute('draggable', 'false');
              el.style.userSelect = 'text';
              el.style.pointerEvents = 'auto';

              const mainEl = el.querySelector('.fc-event-main');
              if (mainEl) {
                mainEl.style.userSelect = 'text';
                mainEl.style.pointerEvents = 'auto';
                mainEl.style.cursor = 'text';
              }
            }
          });

          calendar.render();

          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏õ‡∏µ
          setTimeout(() => {
            const titleEl = document.querySelector('.fc-toolbar-title');
            if (titleEl && !titleEl.querySelector('a')) {
              const link = document.createElement('a');
              link.href = "https://docs.google.com/spreadsheets/d/1_qWz08XrhW9o1L-uz3utLjRksfV3pOsvBNsSus0httw/edit?usp=sharing";
              link.target = "_blank";
              link.textContent = " üîó";
              link.style.marginLeft = "3px";
              link.style.textDecoration = "none";
              link.title = "‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
              titleEl.appendChild(link);
            }
          }, 0);

          // ‚úÖ Export to Excel
          exportBtn.addEventListener('click', () => {
            const data = events.map(e => ({
              ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: e.start,
              ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: e.title.replace(/<[^>]*>/g, ''), // ‡∏•‡∏ö HTML tag
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: e.description || '',
              ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: e.category || ''
            }));
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°");
            XLSX.writeFile(workbook, "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°.xlsx");
          });
        });
    });
  </script>
  <button id="exportBtn">üì• Export Excel</button>
</body>
</html>
